# Домашнее задание: Обновить ядро в базовой системе

| Основное задание: |
| ---               |

1. Обновить ядро в базовой системе

* Задание со звездочкой
1. Ядро собрано из исходников
1. В образе нормально работают VirtualBox Shared Folders


| Решение: |
| ---      |

### **1) Запуск**

```
vagrant up
...
==> kernel-update: Importing base box 'centos/stream8'...
...
```

В Terminal (pwsh7) необходимо ввести команду, чтоб не ругался на права:

```
$Env:VAGRANT_PREFER_SYSTEM_BIN += 0
```

Подключаемся в виртуалку
```
vagrant ssh

[vagrant@kernel-update ~]$ uname -r
4.18.0-277.el8.x86_64
```
Теперь приступим к обновлению ядра.

### **2) Обновление ядра**


Подключаем репозиторий, откуда возьмем необходимую версию ядра.
```
sudo yum install -y https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm

...
Installed:
  elrepo-release-8.3-1.el8.elrepo.noarch

Complete!
```

В репозитории есть две версии ядер:
- **kernel-ml** — свежие и стабильные ядра
- **kernel-lt** — стабильные ядра с длительной версией поддержки, более старые, чем версия ml.


Ставим последнее ядро:

```
sudo yum --enablerepo elrepo-kernel install kernel-ml -y

...
Installed:
  kernel-ml-6.1.4-1.el8.elrepo.x86_64    kernel-ml-core-6.1.4-1.el8.elrepo.x86_64    kernel-ml-modules-6.1.4-1.el8.elrepo.x86_64

Complete!
```
Параметр *--enablerepo elrepo-kernel* указывает что пакет ядра будет запрошен из репозитория elrepo-kernel.



### **3) Обновление загрузчика grub**
После успешной установки нам необходимо сказать системе, что при загрузке нужно использовать новое ядро. В случае обновления ядра на рабочих серверах необходимо перезагрузиться с новым ядром, выбрав его при загрузке. И только при успешно прошедших загрузке нового ядра и тестах сервера переходить к загрузке с новым ядром по-умолчанию. В тестовой среде можно обойти данный этап и сразу назначить новое ядро по-умолчанию. 

- Обновляем конфигурацию загрузчика:
```
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```
- Выбираем загрузку с новым ядром по-умолчанию:
```
sudo grub2-set-default 0
```
- Перезагружаем виртуальную машину:
```
sudo reboot
```
- После перезагрузки снова проверяем версию ядра (версия должа стать новее):
```
[vagrant@kernel-update ~]$ uname -r
6.1.4-1.el8.elrepo.x86_64
```

---

# **II Packer **

### **1) packer provision config**
Файл `centos.json` содержит описание того, как произвольный образ. Полное описание можно найти в документации к `packer`. Обратим внимание на основные секции или ключи.

Создаем переменные (`variables`) с версией и названием нашего проекта (artifact):
```
    "artifact_description": "CentOS Stream 8 with kernel 5.x",
    "artifact_version": "8",
    "image_name": "centos-8"
```

В секции `builders` задаем исходный образ, для создания своего в виде ссылки и контрольной суммы. Параметры подключения к создаваемой виртуальной машине.

```
      "iso_url": "https://mirror.yandex.ru/centos/8-stream/isos/x86_64/CentOS-Stream-8-x86_64-20221222-boot.iso", 
      "iso_checksum": "sha256:70030af1dff1aed857e9a53311b452d330fa82902b3567f6640f119f9fa29e70",
```
В секции `post-processors` указываем имя файла, куда будет сохранен образ, в случае успешной сборки

```
    "output": "centos-{{user `artifact_version`}}-kernel-5-x86_64-Minimal.box",
```

В секции `provisioners` указываем каким образом и какие действия необходимо произвести для настройки виртуальой машины. Именно в этой секции мы и обновим ядро системы, чтобы можно было получить образ с 5й версией ядра. Настройка системы выполняется несколькими скриптами, заданными в секции `scripts`.

```
    "scripts" : 
      [
        "scripts/stage-1-kernel-update.sh",
        "scripts/stage-2-clean.sh"
      ]
```
Скрипты будут выполнены в порядке указания. Первый скрипт включает себя набор команд, которые мы ранее выполняли вручную, чтобы обновить ядро. Второй скрипт занимается подготовкой системы к упаковке в образ. Она заключается в очистке директорий с логами, временными файлами, кешами. Это позволяет уменьшить результирующий образ. Более подробно можно ознакомиться с ними в директории `packer/scripts`

Секция `post-processors` описывает постобработку виртуальной машины при ее выгрузке. Мы указыаем имя файла, в который будет сохранен результат (artifact). Обратите внимание, что имя задается на основе ранее созданной пользовательской переменной `artifact_version` значение которой мы задали ранее:

```
    "output": "centos-{{user `artifact_version`}}-kernel-5-x86_64-Minimal.box",
```

### **2) packer build**
Для создания образа системы достаточно перейти в директорию `packer` и в ней выполнить команду:

```
packer build centos.json

...
Build 'centos-8' finished after 15 minutes 25 seconds.

==> Wait completed after 15 minutes 25 seconds

==> Builds finished. The artifacts of successful builds are:
--> centos-8: 'virtualbox' provider box: centos-8-kernel-5-x86_64-Minimal.box
...
```



### **3) vagrant init (тестирование)**
Проведем тестирование созданного образа. Выполним его импорт в `vagrant`:

```
vagrant box add centos8-kernel5 centos-8-kernel-5-x86_64-Minimal.box

...
==> box: Successfully added box 'centos8-kernel5' (v0) for 'virtualbox'!
...
```

Проверим его в списке имеющихся образов (ваш вывод может отличаться):

```
vagrant box list

...
centos8-kernel5 (virtualbox, 0)
...
```

Теперь необходимо провести тестирование полученного образа. Для этого создадим новый Vagrantfile или воспользуемся имеющимся. Для нового создадим директорию `test` и в ней выполним:

```
vagrant init centos8-kernel5
```

Теперь запустим виртуальную машину, подключимся к ней и проверим, что у нас в ней новое ядро:

```
vagrant up
...
vagrant ssh    
```

и внутри виртуальной машины:

```
[vagrant@kernel-update ~]$ uname -r
6.1.5-1.el8.elrepo.x86_64
```

Если все в порядке, то машина будет запущена и загрузится с новым ядром. В данном примере это `6.1.5`.

Удалим тестовый образ из локального хранилища:
```
vagrant box remove centos8-kernel5
```
---
# **III Packer **


Поделимся полученным образом с сообществом. Для этого зальем его в Vagrant Cloud. Можно залить через web-интерфейс, но так же `vagrant` позволяет это проделать через CLI.
Логинимся в `vagrant cloud`, указывая e-mail, пароль и описание выданого токена (можно оставить по-умолчанию)
```
vagrant cloud auth login
Vagrant Cloud username or email: <user_email>
Password (will be hidden): 
Token description (Defaults to "Vagrant login from DS-WS"):
You are now logged in.
```
Теперь публикуем полученный бокс:
```
vagrant cloud publish --release <username>/centos-8 1.0 virtualbox \
        centos-8-kernel-5-x86_64-Minimal.box
```
Здесь:
 - `cloud publish` - загрузить образ в облако;
 - `release` - указывает на необходимость публикации образа после загрузки;
 - `<username>/centos-8` - `username`, указаный при публикации и имя образа;
 - `1.0` - версия образа;
 - `virtualbox` - провайдер;
 - `centos-8-kernel-5-x86_64-Minimal.box` - имя файла загружаемого образа;

После успешной загрузки вы получите сообщение:

```
Complete! Published <username>/centos-8
Box:              <username>/centos-8
Description:
Private:          yes
Created:          2023-01-12T21:04:56.803+01:00
Updated:          2023-01-12T21:04:56.803+01:00
Current Version:  N/A
Versions:         1.0
Downloads:        0
```

В результате создан и загружен в `vagrant cloud` образ виртуальной машины. Данный подход позволяет создать базовый образ виртульной машины с необходимыми обновлениями или набором предустановленного ПО. К примеру при создании MySQL-кластера можно создать образ с предустановленным MySQL, а при развертывании нужно будет добавить или изменить только настройки (то есть отличающуюся часть). Таким образом существенно экономя затрачиваемое время.
